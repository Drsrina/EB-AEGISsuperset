=============================================================================
MANUAL_CONFIG.txt - Configuração Manual do Cloud Run para Superset
=============================================================================

Este arquivo descreve a estratégia de deploy do Apache Superset no Google Cloud Run, 
utilizando a arquitetura de "Job de Setup" + "Serviço Web".

=============================================================================
VARIÁVEIS DE AMBIENTE NECESSÁRIAS
=============================================================================

Configure estas variáveis no Cloud Run (tanto no Job quanto no Service):

1. SECRET_KEY (CRÍTICO - SEGURANÇA)
   Descrição: Chave secreta para criptografia de sessões e cookies
   Como gerar: Execute em um terminal Python ou Linux:
   
   python -c "import secrets; print(secrets.token_hex(32))"
   
   Exemplo: a1b2c3d4e5f6...  (64 caracteres hexadecimais)

2. SQLALCHEMY_DATABASE_URI (CRÍTICO - BANCO DE DADOS)
   Descrição: String de conexão com o banco de dados principal
   
   Formatos de Conexão:
   
   PostgreSQL (Supabase/Cloud SQL):
   postgresql://usuario:senha@host:5432/nome_banco
   
   MySQL/MariaDB:
   mysql+pymysql://usuario:senha@host:3306/nome_banco
   
   BigQuery:
   bigquery://project-id/dataset-name
   
   IMPORTANTE: 
   - Para Cloud SQL, use o Proxy de Conexão Unix Socket ou IP privado
   - Para Supabase, use a connection string "Direct Connection" (porta 5432)

3. REDIS_URL (OPCIONAL - PERFORMANCE)
   Descrição: URL de conexão com Redis para cache de queries e metadados
   
   Formato Upstash Redis (SSL obrigatório):
   rediss://:sua-senha@endpoint.upstash.io:6379
   
   Nota: Se não configurado, o Superset usará cache em memória (SimpleCache)
         com capacidade para 50.000 objetos na RAM.

=============================================================================
PASSO 1: CRIAR O ARTIFACT REGISTRY REPOSITORY
=============================================================================

No console do GCP, acesse o Artifact Registry e crie um repositório:

Nome: superset-repo
Região: us-central1
Tipo: Docker

Ou execute via gcloud CLI:

gcloud artifacts repositories create superset-repo \
  --repository-format=docker \
  --location=us-central1 \
  --description="Repositório para imagens do Superset"

=============================================================================
PASSO 2: CONFIGURAR O CLOUD BUILD TRIGGER
=============================================================================

1. Acesse Cloud Build > Triggers no console do GCP
2. Clique em "Create Trigger"
3. Configure:
   - Nome: superset-auto-deploy
   - Repositório: Conecte ao seu repositório GitHub
   - Branch: ^main$ (deploy automático ao fazer push na main)
   - Arquivo de configuração: cloudbuild.yaml
   - Service Account: Conceda permissões de Cloud Run Admin e Artifact Registry Writer

4. Salve o trigger

=============================================================================
PASSO 3: CRIAR O CLOUD RUN JOB (INICIALIZAÇÃO DO BANCO)
=============================================================================

Este Job executa APENAS na primeira vez ou quando você precisa rodar migrations:

Nome: superset-init-job
Região: us-central1
Imagem: us-central1-docker.pkg.dev/SEU-PROJECT-ID/superset-repo/superset-prod
Comando (Container arguments):

/bin/sh,-c,superset db upgrade && superset fab create-admin --username admin --firstname Admin --lastname User --email admin@exemplo.com --password SenhaSegura123 && superset init

VARIÁVEIS DE AMBIENTE:
- SECRET_KEY: (cole sua chave gerada)
- SQLALCHEMY_DATABASE_URI: (cole sua connection string)
- REDIS_URL: (cole se estiver usando Upstash Redis)

RECURSOS:
- CPU: 2
- Memória: 4GB
- Timeout: 600 segundos (10 minutos)

Execute este Job MANUALMENTE sempre que:
- For a primeira inicialização do banco
- Precisar aplicar migrations após atualizar o Superset
- Precisar criar novos usuários admin

=============================================================================
PASSO 4: CRIAR O CLOUD RUN SERVICE (APLICAÇÃO WEB)
=============================================================================

Este Service roda continuamente para servir a interface web:

Nome: superset-prod
Região: us-central1
Imagem: us-central1-docker.pkg.dev/SEU-PROJECT-ID/superset-repo/superset-prod
Comando (Container command):

/bin/sh

Argumentos (Container arguments):

-c,gunicorn -w 4 -k gthread --threads 8 --timeout 120 -b 0.0.0.0:8088 'superset.app:create_app()'

VARIÁVEIS DE AMBIENTE (MESMAS DO JOB):
- SECRET_KEY: (cole sua chave gerada)
- SQLALCHEMY_DATABASE_URI: (cole sua connection string)
- REDIS_URL: (cole se estiver usando Upstash Redis)

RECURSOS (OTIMIZADO PARA 8GB RAM / 4 CPU):
- CPU: 4
- Memória: 8GB
- Min Instances: 1 (evita cold start)
- Max Instances: 10
- Request timeout: 300 segundos
- Container Port: 8088

AUTENTICAÇÃO:
- Autenticação: "Require authentication" (recomendado para segurança)
- Para acesso público, altere para "Allow unauthenticated invocations"

CONFIGURAÇÕES ADICIONAIS:
- Concurrency: 80 (Gunicorn com 4 workers x 8 threads = 32 conexões simultâneas)
- Session affinity: Desabilitado

=============================================================================
PASSO 5: CONFIGURAÇÃO DE DOMÍNIO CUSTOMIZADO (OPCIONAL)
=============================================================================

Para mapear um domínio próprio (ex: bi.suaempresa.com):

1. Acesse Cloud Run > Domain Mappings
2. Clique em "Add Mapping"
3. Selecione o serviço superset-prod
4. Insira seu domínio: bi.suaempresa.com
5. Copie os registros DNS fornecidos pelo GCP
6. Configure os registros DNS no seu provedor de domínio
7. Aguarde a propagação (pode levar até 24 horas)

=============================================================================
WORKFLOW DE DEPLOY AUTOMÁTICO
=============================================================================

Após configurar tudo acima, o workflow será:

1. Você faz alterações nos arquivos do repositório
2. Faz commit e push para a branch 'main' no GitHub
3. O Cloud Build detecta o push e inicia o build automaticamente
4. Etapas:
   a) Build da imagem Docker usando Dockerfile.cloudrun
   b) Push da imagem para o Artifact Registry
   c) Deploy automático da nova imagem no Cloud Run Service
5. O serviço é atualizado com zero downtime (rolling update)
6. Acesse a URL do Cloud Run para verificar a atualização

NOTA: O Job de inicialização NÃO é executado automaticamente. 
Execute-o manualmente apenas quando necessário.

=============================================================================
FORMATOS DE CONEXÃO COM BANCOS DE DADOS
=============================================================================

MySQL/MariaDB (Cloud SQL ou externo):
mysql+pymysql://usuario:senha@host:3306/nome_banco

PostgreSQL (Supabase, Cloud SQL, ou externo):
postgresql://usuario:senha@host:5432/nome_banco

BigQuery:
bigquery://project-id/dataset-name

Cloud SQL via Unix Socket (mais seguro):
postgresql+psycopg2://usuario:senha@/nome_banco?host=/cloudsql/project-id:region:instance-name

=============================================================================
TROUBLESHOOTING
=============================================================================

PROBLEMA: Build falha com erro de instalação do mysqlclient
SOLUÇÃO: Verifique se o Dockerfile.cloudrun contém as dependências MySQL

PROBLEMA: Superset não inicia (erro 500)
SOLUÇÃO: Verifique os logs do Cloud Run e confirme que as variáveis de 
         ambiente estão corretas, especialmente SQLALCHEMY_DATABASE_URI

PROBLEMA: Erro "Table 'ab_user' doesn't exist"
SOLUÇÃO: Execute o Cloud Run Job de inicialização (superset-init-job)

PROBLEMA: Cache não funciona
SOLUÇÃO: Verifique se REDIS_URL está correta e se o Redis está acessível.
         Use 'rediss://' (com dois 's') para Upstash Redis (SSL).

PROBLEMA: Queries lentas no BigQuery
SOLUÇÃO: Os timeouts já estão configurados para 600 segundos. Se ainda for
         insuficiente, aumente os valores em superset_config.py

=============================================================================
